---
title: 关于矩阵求导
date: 2023-08-22 23:24:00 +0900
categories: [Math, Matrix calculus]
tags: [machine learning, math, matrix calculus]     # TAG names should always be lowercase
math: true
---

## 概念准备
在进行矩阵求导之前，我们首先需要做一些关于概念上的铺垫。主要分为以下两个部分：
- 函数与变元的种类
- 分子布局与分母布局
  
### 函数与变元的种类
这里的种类指的就是**标量、向量和矩阵**这三种。在本文后续内容中对于这三种形式的符号表达都遵循如下定义:
- 标量，用正文字体小写字母表示，例如： 
$$
x, y
$$

- 向量，用粗体小写字母表示，例如：
$$
\boldsymbol{x}_{n \times 1} = \begin{pmatrix} x_1, x_2, \cdots, x_n \end{pmatrix}^T
$$

- 矩阵，用粗体大写字母表示，例如：
$$
\boldsymbol{X}_{m \times n}
=
\begin{pmatrix}
    x_{11} & x_{12} & \cdots & x_{1n} \\
    x_{21} & x_{22} & \cdots & x_{2n} \\
    \vdots & \vdots & \ddots & \vdots \\
    x_{m1} & x_{m2} & \cdots & x_{mn}
\end{pmatrix}
$$

接下来是具体分类：
1. 函数为**标量**，称之为**实值标量函数**，根据变元种类分为以下三种：
   - 变元为**标量**，例:
  
   $$
   f(x) = x^2
   $$

   - 变元为**向量**， 例:
   
   $$
   \begin{aligned}
        & \boldsymbol{x}_{3 \times 1} = \begin{pmatrix} x_1, x_2, x_3 \end{pmatrix}^T 
        \\[5mm]
        & f(\boldsymbol{x}) = x_1^2 + x_2^2 + x_3^2
   \end{aligned}
   $$

   - 变元为**矩阵**， 例：
   
   $$
   \begin{aligned}
        \boldsymbol{X}_{2 \times 3} 
        &=
        \begin{pmatrix}
            x_{11} & x_{12} & x_{13} \\
            x_{21} & x_{22} & x_{23}
        \end{pmatrix} 
        \\[5mm]
        f(\boldsymbol{X})
        &=
        x_{11}^2 + x_{12} + x_{13} + x_{21} + x_{22} + x_{23}
   \end{aligned}
   $$

2. 函数为**向量**，称之为**实向量函数**，根据变元种类分为以下三种：
   - 变元为**标量**， 例：
   
   $$
   \boldsymbol{f}_{3 \times 1}(x) =
   \begin{pmatrix}
       f_1(x) \\ f_2(x) \\ f_3(x)
   \end{pmatrix} =
   \begin{pmatrix}
       x \\ x^2 \\ x^3
   \end{pmatrix}
   $$

   - 变元为**向量**， 例：
   
   $$
   \begin{aligned}
        \boldsymbol{x}_{3 \times 1} 
        &= 
        \begin{pmatrix} x_1 & x_2 & x_3 \end{pmatrix}^T 
        \\[5mm]
        \boldsymbol{f}_{3 \times 1}(\boldsymbol{x}) 
        &=
        \begin{pmatrix}
            f_1(\boldsymbol{x}) \\ f_2(\boldsymbol{x}) \\ f_3(\boldsymbol{x})
        \end{pmatrix} =
        \begin{pmatrix}
            x_1 + x_2 \\ x_2 + x_3 \\ x_3 + x_1
        \end{pmatrix}
   \end{aligned}
   $$

   - 变元为**矩阵**， 例：
   
   $$
   \begin{aligned}
        \boldsymbol{X}_{2 \times 3} 
        &=
        \begin{pmatrix}
            x_{11} & x_{12} & x_{13} \\
            x_{21} & x_{22} & x_{23}
        \end{pmatrix} 
        \\[7mm]
        \boldsymbol{f}_{3 \times 1}(\boldsymbol{X}) 
        &=
        \begin{pmatrix}
            f_1(\boldsymbol{\boldsymbol{X}}) \\ f_2(\boldsymbol{\boldsymbol{X}}) \\ f_3(\boldsymbol{\boldsymbol{X}})
        \end{pmatrix} 
        \\[7mm]
        &=
        \begin{pmatrix}
            x_{11} + x_{12} + x_{21}^2 \\ x_{13} + x_{21} + x_{22}^2 \\ x_{22} + x_{23} + x_{23}^2
        \end{pmatrix}
   \end{aligned}
   $$

3. 函数为**矩阵**， 称之为**实矩阵函数**，根据变元种类分为以下三种：
   - 变元为**标量**， 例：
   
   $$
   \begin{aligned}
        \boldsymbol{F}_{2 \times 3}(x)
        &=
        \begin{pmatrix}
            f_{11}(x) & f_{12}(x) & f_{13}(x) \\
            f_{21}(x) & f_{22}(x) & f_{23}(x)
        \end{pmatrix} 
        \\[5mm]
        &=
        \begin{pmatrix}
            x & 2x & 3x \\
            x^2 & 2x^2 & 3x^3
        \end{pmatrix}
   \end{aligned}
   $$

   - 变元为**向量**， 例：
   
   $$
   \begin{aligned}
        \boldsymbol{x}_{3 \times 1}
        &=
        \begin{pmatrix}
            x_{11} & x_{12} & x_{13}
        \end{pmatrix}^T
        \\[5mm]
        \boldsymbol{F}_{2 \times 3}(\boldsymbol{x})
        &=
        \begin{pmatrix}
            f_{11}(\boldsymbol{x}) & f_{12}(\boldsymbol{x}) & f_{13}(\boldsymbol{x}) \\
            f_{21}(\boldsymbol{x}) & f_{22}(\boldsymbol{x}) & f_{23}(\boldsymbol{x})
        \end{pmatrix} 
        \\[5mm]
        &=
        \begin{pmatrix}
            x_{11} + x_{12} + x_{13} & 2x_{11} + x_{12} + x_{13} & 3x_{11} + x_{12} + x_{13} \\
            4x_{11} + x_{12} + x_{13} & 5x_{11} + x_{12} + x_{13} & 6x_{11} + x_{12} + x_{13}
        \end{pmatrix}
   \end{aligned}
   $$

   - 变元为**矩阵**， 例：
   
   $$
   \begin{aligned}
        \boldsymbol{X}_{2 \times 3} 
        &=
        \begin{pmatrix}
            x_{11} & x_{12} & x_{13} \\
            x_{21} & x_{22} & x_{23}
        \end{pmatrix} 
        \\[7mm]
        \boldsymbol{F}_{3 \times 2}(\boldsymbol{X})
        &=
        \begin{pmatrix}
            f_{11}(\boldsymbol{X}) & f_{12}(\boldsymbol{X}) \\ 
            f_{21}(\boldsymbol{X}) & f_{22}(\boldsymbol{X}) \\ 
            f_{31}(\boldsymbol{X}) & f_{32}(\boldsymbol{X})
        \end{pmatrix} 
        \\[7mm]
        &=
        \begin{pmatrix}
            x_{11} + x_{12} + x_{13} + x_{21} + x_{22} + x_{23} & 2x_{11} + x_{12} + x_{13} + x_{21} + x_{22} + x_{23} \\ 
            3x_{11} + x_{12} + x_{13} + x_{21} + x_{22} + x_{23} & 4x_{11} + x_{12} + x_{13} + x_{21} + x_{22} + x_{23} \\ 
            5x_{11} + x_{12} + x_{13} + x_{21} + x_{22} + x_{23} & 6x_{11} + x_{12} + x_{13} + x_{21} + x_{22} + x_{23}
        \end{pmatrix}
   \end{aligned}
   $$

最后关于函数和变元的种类，可以总结如下：

| 函数 \ 变元 | 标量变元 | 向量变元 | 矩阵变元 |
| --- | --- | --- | --- |
| 实值标量函数 | $f(x)$| $f(\boldsymbol{x})$ | $f\boldsymbol{(X)}$ |
| 实向量函数 | $\boldsymbol{f}(x)$ | $\boldsymbol{f}(\boldsymbol{x})$ | $\boldsymbol{f}(\boldsymbol{X})$ |
| 实矩阵函数 | $\boldsymbol{F}(x)$ | $\boldsymbol{F}(\boldsymbol{x}) $ | $\boldsymbol{F}(\boldsymbol{X})$ |

### 分子布局与分母布局
进行矩阵求导的时候实际上是将函数中的每一个分量依次对变元中的每一个分量求偏导，并将所有求偏导的结果排列起来，根据不同的排列规则分为**分子布局** (Numerator Layout) 和 **分母布局** (Denominator Layout)。举一个例子：

$$
\boldsymbol{x} = 
\begin{pmatrix}
    x_1 \\ x_2 \\ \vdots \\ x_n
\end{pmatrix}_{n \times 1}
, \qquad
\frac{\partial{f}}{\partial{\boldsymbol{x}}} =
\begin{pmatrix}
    \frac{\partial{f}}{\partial{x_1}} \\ \frac{\partial{f}}{\partial{x_2}} \\ \vdots \\ \frac{\partial{f}}{\partial{x_n}}
\end{pmatrix}_{n \times 1}
$$

这里的 $f(\boldsymbol{x})$ 是一个实值标量函数，而变元 $\boldsymbol{x}$ 是一个 $n \times 1$ 的列向量，求完导后的结果也是一个 $n \times 1$ 的列向量。如果把这里求导的式子 $\frac{\partial{f}}{\partial{\boldsymbol{x}}}$ 视作分式的话可以发现，求导结果的维度与分母 $\boldsymbol{x}$ 一致，所以这里采用的是**分母布局**。再举一个例子：

$$
\boldsymbol{x} = 
\begin{pmatrix}
    x_1 \\ x_2 \\ \vdots \\ x_n
\end{pmatrix}_{n \times 1}
, \qquad
\boldsymbol{f} = 
\begin{pmatrix}
    f_1 \\ f_2 \\ \vdots \\ f_m
\end{pmatrix}_{m \times 1}
, \qquad
\frac{\partial{\boldsymbol{f}}}{\partial{\boldsymbol{x}}} =
\begin{pmatrix}
    \color{purple}{\frac{\partial{f_1}}{\partial{x_1}}} & \color{blue}{\frac{\partial{f_2}}{\partial{x_1}}} & \color{blue}{\cdots} & \color{blue}{\frac{\partial{f_m}}{\partial{x_1}}} \\
    \color{red}{\frac{\partial{f_1}}{\partial{x_2}}} & \frac{\partial{f_2}}{\partial{x_2}} & \cdots & \frac{\partial{f_m}}{\partial{x_2}} \\
    \color{red}{\vdots} & \vdots & \ddots & \vdots \\
    \color{red}{\frac{\partial{f_1}}{\partial{x_n}}} & \frac{\partial{f_2}}{\partial{x_n}} & \cdots & \frac{\partial{f_m}}{\partial{x_n}} 
\end{pmatrix}_{n \times m}
$$

这里的 $\boldsymbol{f}(\boldsymbol{x})$ 是一个 $m \times 1$ 的实向量函数，而变元 $\boldsymbol{x}$ 是一个 $n \times 1$ 的列向量，求导的结果是一个 $n \times m$ 的矩阵。我们可以看到这个结果符合变元 $\boldsymbol{x}$ 的排列方式（红色部分），而函数 $\boldsymbol{f}$ 则转变为行向量的排列方式（蓝色部分），也就是转置了。这里采用的还是**分母布局**。如果采用**分子布局**的话：

$$
\frac{\partial{\boldsymbol{f}}}{\partial{\boldsymbol{x}}} =
\begin{pmatrix}
    \color{purple}{\frac{\partial{f_1}}{\partial{x_1}}} & \color{blue}{\frac{\partial{f_1}}{\partial{x_2}}} & \color{blue}{\cdots} & \color{blue}{\frac{\partial{f_1}}{\partial{x_n}}} \\
    \color{red}{\frac{\partial{f_2}}{\partial{x_1}}} & \frac{\partial{f_2}}{\partial{x_2}} & \cdots & \frac{\partial{f_2}}{\partial{x_n}} \\
    \color{red}{\vdots} & \vdots & \ddots & \vdots \\
    \color{red}{\frac{\partial{f_m}}{\partial{x_1}}} & \frac{\partial{f_m}}{\partial{x_2}} & \cdots & \frac{\partial{f_m}}{\partial{x_n}} 
\end{pmatrix}_{m \times n}
$$

结果就是一个 $m \times n$ 的矩阵，变元 $\boldsymbol{x}$ 发生了转置。

| 函数 \ 变元 | 标量变元 | 向量变元 | 矩阵变元 |
| --- | --- | --- | --- |
| 实值标量函数 | $f(x)$| $\color{red}{f(\boldsymbol{x})}$ | $\color{red}{f\boldsymbol{(X)}}$ |
| 实向量函数 | $\color{red}{\boldsymbol{f}(x)}$ | $\color{red}{\boldsymbol{f}(\boldsymbol{x})}$ | $\boldsymbol{f}(\boldsymbol{X})$ |
| 实矩阵函数 | $\color{red}{\boldsymbol{F}(x)}$ | $\boldsymbol{F}(\boldsymbol{x}) $ | $\boldsymbol{F}(\boldsymbol{X})$ |

本文后续关于求导的部分只讨论上表中标注为红色的情况，那么关于求导的布局可以通俗地总结为：**矩阵求导结果是什么布局由分子、分母中没有发生转置的那一个决定。**